<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AuthenticationRequest.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">openid-connect-core</a> &gt; <a href="index.source.html" class="el_package">net.trajano.openidconnect.auth</a> &gt; <span class="el_source">AuthenticationRequest.java</span></div><h1>AuthenticationRequest.java</h1><pre class="source lang-java linenums">package net.trajano.openidconnect.auth;

import static net.trajano.openidconnect.core.ErrorCode.invalid_request;

import java.io.IOException;
import java.io.StringReader;
import java.net.URI;
import java.security.GeneralSecurityException;
import java.util.Collections;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;

import javax.json.Json;
import javax.json.JsonObject;
import javax.json.JsonObjectBuilder;
import javax.json.JsonValue.ValueType;
import javax.servlet.http.HttpServletRequest;
import javax.validation.constraints.NotNull;
import javax.ws.rs.BadRequestException;
import javax.ws.rs.core.UriBuilder;
import javax.xml.bind.annotation.XmlTransient;

import net.trajano.openidconnect.core.ErrorResponse;
import net.trajano.openidconnect.core.OpenIdConnectKey;
import net.trajano.openidconnect.core.RedirectedOpenIdProviderException;
import net.trajano.openidconnect.core.Scope;
import net.trajano.openidconnect.crypto.JsonWebKeySet;
import net.trajano.openidconnect.crypto.JsonWebToken;
import net.trajano.openidconnect.crypto.JsonWebTokenProcessor;
import net.trajano.openidconnect.internal.Util;

/**
 * Wraps an HttpServletRequest to provide a cleaner API to the request
 * parameters. This is not serializable as the serialized version will already
 * be in JWT.
 *
 * @author Archimedes
 */
public class AuthenticationRequest {

    /**
     * Builder for the Authentication request
     *
     * @author Archimedes
     */
<span class="nc" id="L52">    public static class Builder {</span>

<span class="nc" id="L54">        private final Map&lt;String, String&gt; requestMap = new HashMap&lt;&gt;();</span>

        public AuthenticationRequest build() throws IOException,
            GeneralSecurityException {

<span class="nc" id="L59">            return new AuthenticationRequest(requestMap);</span>
        }

        public Builder clientId(final String s) {

<span class="nc" id="L64">            requestMap.put(OpenIdConnectKey.CLIENT_ID, s);</span>
<span class="nc" id="L65">            return this;</span>
        }

        public Builder nonce(final String s) {

<span class="nc" id="L70">            requestMap.put(OpenIdConnectKey.NONCE, s);</span>
<span class="nc" id="L71">            return this;</span>
        }

        public Builder redirectUri(final URI uri) {

<span class="nc" id="L76">            requestMap.put(OpenIdConnectKey.REDIRECT_URI, uri.toASCIIString());</span>
<span class="nc" id="L77">            return this;</span>
        }

        public Builder responseMode(final ResponseMode mode) {

<span class="nc bnc" id="L82" title="All 2 branches missed.">            if (mode != ResponseMode.query) {</span>
<span class="nc" id="L83">                requestMap.put(OpenIdConnectKey.RESPONSE_MODE, mode.name());</span>
            }
<span class="nc" id="L85">            return this;</span>
        }

        public Builder responseType(@NotNull final ResponseType code,
            final ResponseType... oth) {

<span class="nc" id="L91">            final StringBuilder b = new StringBuilder(code.name());</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            for (final ResponseType type : oth) {</span>
<span class="nc" id="L93">                b.append(' ');</span>
<span class="nc" id="L94">                b.append(type.name());</span>
            }
<span class="nc" id="L96">            requestMap.put(OpenIdConnectKey.RESPONSE_TYPE, b.toString());</span>
<span class="nc" id="L97">            return this;</span>
        }

        public Builder scope(final String scope) {

<span class="nc" id="L102">            requestMap.put(OpenIdConnectKey.SCOPE, scope);</span>
<span class="nc" id="L103">            return this;</span>
        }

        public Builder state(final String s) {

<span class="nc" id="L108">            requestMap.put(OpenIdConnectKey.STATE, s);</span>
<span class="nc" id="L109">            return this;</span>
        }

        public Builder uiLocale(final Enumeration&lt;Locale&gt; locales) {

<span class="nc bnc" id="L114" title="All 2 branches missed.">            if (locales != null) {</span>
<span class="nc" id="L115">                final StringBuilder b = new StringBuilder(locales.nextElement()</span>
<span class="nc" id="L116">                    .toLanguageTag());</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">                while (locales.hasMoreElements()) {</span>
<span class="nc" id="L119">                    b.append(' ');</span>
<span class="nc" id="L120">                    b.append(locales.nextElement()</span>
<span class="nc" id="L121">                        .toLanguageTag());</span>
                }
<span class="nc" id="L123">                requestMap.put(OpenIdConnectKey.UI_LOCALES, b.toString());</span>
            }
<span class="nc" id="L125">            return this;</span>
        }
    }

    /**
     * Keys for objects that go to the request object when serialized to a JWT.
     */
<span class="fc" id="L132">    private static final String[] REQUEST_KEYS = {</span>
        OpenIdConnectKey.ACR_VALUES,
        OpenIdConnectKey.CLIENT_ID,
        OpenIdConnectKey.CLAIMS,
        OpenIdConnectKey.DISPLAY,
        OpenIdConnectKey.ID_TOKEN_HINT,
        OpenIdConnectKey.LOGIN_HINT,
        OpenIdConnectKey.MAX_AGE,
        OpenIdConnectKey.NONCE,
        OpenIdConnectKey.PROMPT,
        OpenIdConnectKey.REDIRECT_URI,
        OpenIdConnectKey.RESPONSE_MODE,
        OpenIdConnectKey.RESPONSE_TYPE,
        OpenIdConnectKey.SCOPE,
        OpenIdConnectKey.STATE,
        OpenIdConnectKey.UI_LOCALES };

    private static Map&lt;String, String&gt; buildRequestMap(final HttpServletRequest req,
        final JsonWebKeySet privateJwks) throws IOException,
            GeneralSecurityException {

<span class="fc" id="L153">        final Map&lt;String, String&gt; requestMap = new HashMap&lt;&gt;();</span>

        final JsonObject requestObject;
<span class="pc bpc" id="L156" title="2 of 4 branches missed.">        if (req.getParameter(OpenIdConnectKey.REQUEST) != null &amp;&amp; privateJwks != null) {</span>
<span class="fc" id="L157">            final JsonWebToken jwt = new JsonWebToken(req.getParameter(OpenIdConnectKey.REQUEST));</span>
<span class="fc" id="L158">            final JsonWebTokenProcessor p = new JsonWebTokenProcessor(jwt).jwks(privateJwks);</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">            if (!p.isJwkAvailable()) {</span>
<span class="nc" id="L160">                throw new GeneralSecurityException(&quot;jwk not available for kid&quot;);</span>
            }
<span class="fc" id="L162">            requestObject = p.getJsonPayload();</span>
<span class="fc" id="L163">        } else {</span>
<span class="nc" id="L164">            requestObject = null;</span>
        }
<span class="fc bfc" id="L166" title="All 2 branches covered.">        for (final String key : REQUEST_KEYS) {</span>
<span class="fc" id="L167">            processValueFromMapOrObject(requestMap, key, req, requestObject);</span>
        }
<span class="fc" id="L169">        return requestMap;</span>
    }

    private static Map&lt;String, String&gt; buildRequestMap(final String requestJwt,
        final JsonWebKeySet privateJwks) throws IOException,
            GeneralSecurityException {

<span class="nc" id="L176">        final Map&lt;String, String&gt; requestMap = new HashMap&lt;&gt;();</span>

        final JsonObject requestObject;
<span class="nc bnc" id="L179" title="All 4 branches missed.">        if (requestJwt != null &amp;&amp; privateJwks != null) {</span>
<span class="nc" id="L180">            final JsonWebToken jwt = new JsonWebToken(requestJwt);</span>
<span class="nc" id="L181">            final JsonWebTokenProcessor p = new JsonWebTokenProcessor(jwt).jwks(privateJwks);</span>
<span class="nc" id="L182">            requestObject = p.getJsonPayload();</span>
<span class="nc" id="L183">        } else {</span>
<span class="nc" id="L184">            requestObject = null;</span>
        }
<span class="nc bnc" id="L186" title="All 2 branches missed.">        for (final String key : REQUEST_KEYS) {</span>
<span class="nc" id="L187">            processValueFromMapOrObject(requestMap, key, null, requestObject);</span>
        }
<span class="nc" id="L189">        return requestMap;</span>
    }

    /**
     * &lt;p&gt;
     * So that the request is a valid OAuth 2.0 Authorization Request, values
     * for the response_type and client_id parameters MUST be included using the
     * OAuth 2.0 request syntax, since they are REQUIRED by OAuth 2.0. The
     * values for these parameters MUST match those in the Request Object, if
     * present.
     * &lt;/p&gt;
     *
     * @param reqMap
     * @param key
     * @param servletRequest
     * @param requestObject
     */
    private static void processValueFromMapOrObject(final Map&lt;String, String&gt; reqMap,
        final String key,
        final HttpServletRequest servletRequest,
        final JsonObject requestObject) {

        final String paramValue;
<span class="pc bpc" id="L212" title="1 of 4 branches missed.">        if (servletRequest != null &amp;&amp; servletRequest.getParameter(key) != null) {</span>
<span class="fc" id="L213">            paramValue = servletRequest.getParameter(key);</span>
        } else {
<span class="fc" id="L215">            paramValue = null;</span>
        }

        final String requestObjectValue;
<span class="pc bpc" id="L219" title="1 of 4 branches missed.">        if (requestObject == null || !requestObject.containsKey(key)) {</span>
<span class="fc" id="L220">            requestObjectValue = null;</span>
<span class="fc" id="L221">        } else if (requestObject.get(key)</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">            .getValueType() == ValueType.STRING) {</span>
<span class="fc" id="L223">            requestObjectValue = requestObject.getString(key);</span>
<span class="fc" id="L224">        } else if (requestObject.get(key)</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">            .getValueType() == ValueType.NUMBER) {</span>
<span class="fc" id="L226">            requestObjectValue = requestObject.getJsonNumber(key)</span>
<span class="fc" id="L227">                .bigIntegerValueExact()</span>
<span class="fc" id="L228">                .toString();</span>
<span class="nc" id="L229">        } else if (requestObject.get(key)</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            .getValueType() == ValueType.OBJECT) {</span>
<span class="nc" id="L231">            requestObjectValue = requestObject.getJsonObject(key)</span>
<span class="nc" id="L232">                .toString();</span>
        } else {
<span class="nc" id="L234">            requestObjectValue = null;</span>
        }

<span class="pc bpc" id="L237" title="2 of 8 branches missed.">        if (OpenIdConnectKey.CLIENT_ID.equals(key) &amp;&amp; paramValue != null &amp;&amp; requestObjectValue != null &amp;&amp; !paramValue.equals(requestObjectValue)) {</span>
<span class="fc" id="L238">            throw new BadRequestException(&quot;client_id does not match.&quot;);</span>
        }

<span class="pc bpc" id="L241" title="5 of 8 branches missed.">        if (OpenIdConnectKey.REDIRECT_URI.equals(key) &amp;&amp; paramValue != null &amp;&amp; requestObjectValue != null &amp;&amp; !paramValue.equals(requestObjectValue)) {</span>
<span class="nc" id="L242">            throw new BadRequestException(&quot;redirect_uri does not match.&quot;);</span>
        }

<span class="fc bfc" id="L245" title="All 2 branches covered.">        if (Util.isNotNullOrEmpty(requestObjectValue)) {</span>
<span class="fc" id="L246">            reqMap.put(key, requestObjectValue);</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">        } else if (Util.isNotNullOrEmpty(paramValue)) {</span>
<span class="nc" id="L248">            reqMap.put(key, paramValue);</span>
        }
<span class="fc" id="L250">    }</span>

    private final List&lt;String&gt; acrValues;

    /**
     * Claims.
     */
    private final JsonObject claims;

    private final String clientId;

    /**
     * Flag to indicate that &quot;code&quot; is the only response type. This is used in a
     * few places so minor efficiency boost.
     */
    @XmlTransient
    private final boolean codeOnlyResponseType;

    private final Display display;

    private final String idTokenHint;

    private final String loginHint;

    private final Integer maxAge;

    private final String nonce;

    private final Set&lt;Prompt&gt; prompts;

    private final URI redirectUri;

    /**
     * Stringified values for the request.
     */
    private final Map&lt;String, String&gt; requestMap;

    private final ResponseMode responseMode;

    private final Set&lt;ResponseType&gt; responseTypes;

    private final Set&lt;Scope&gt; scopes;

    /**
     * State.
     */
    private final String state;

    private final List&lt;Locale&gt; uiLocales;

    public AuthenticationRequest(final HttpServletRequest req, final JsonWebKeySet privateJwks) throws IOException, GeneralSecurityException {

<span class="fc" id="L302">        this(buildRequestMap(req, privateJwks));</span>
<span class="fc" id="L303">    }</span>

<span class="fc" id="L305">    private AuthenticationRequest(final Map&lt;String, String&gt; requestMap) throws IOException, GeneralSecurityException {</span>

<span class="fc" id="L307">        this.requestMap = requestMap;</span>
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.ACR_VALUES)) {</span>
<span class="nc" id="L309">            acrValues = Util.splitToList(requestMap.get(OpenIdConnectKey.ACR_VALUES));</span>
        } else {
<span class="fc" id="L311">            acrValues = null;</span>
        }
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.CLIENT_ID)) {</span>
<span class="fc" id="L314">            clientId = requestMap.get(OpenIdConnectKey.CLIENT_ID);</span>
        } else {
<span class="nc" id="L316">            clientId = null;</span>
        }
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.CLAIMS)) {</span>
<span class="nc" id="L319">            claims = Json.createReader(new StringReader(requestMap.get(OpenIdConnectKey.CLAIMS)))</span>
<span class="nc" id="L320">                .readObject();</span>
        } else {
<span class="fc" id="L322">            claims = Json.createObjectBuilder()</span>
<span class="fc" id="L323">                .build();</span>
        }
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.DISPLAY)) {</span>
<span class="nc" id="L326">            display = Util.valueOf(Display.class, requestMap.get(OpenIdConnectKey.DISPLAY));</span>
        } else {
<span class="fc" id="L328">            display = null;</span>
        }

<span class="pc bpc" id="L331" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.ID_TOKEN_HINT)) {</span>
<span class="nc" id="L332">            idTokenHint = requestMap.get(OpenIdConnectKey.ID_TOKEN_HINT);</span>
        } else {
<span class="fc" id="L334">            idTokenHint = null;</span>
        }

<span class="pc bpc" id="L337" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.LOGIN_HINT)) {</span>
<span class="nc" id="L338">            loginHint = requestMap.get(OpenIdConnectKey.LOGIN_HINT);</span>
        } else {
<span class="fc" id="L340">            loginHint = null;</span>
        }

<span class="pc bpc" id="L343" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.MAX_AGE)) {</span>
<span class="fc" id="L344">            maxAge = Integer.valueOf(requestMap.get(OpenIdConnectKey.MAX_AGE));</span>
        } else {
<span class="nc" id="L346">            maxAge = null;</span>
        }

<span class="pc bpc" id="L349" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.NONCE)) {</span>
<span class="nc" id="L350">            nonce = requestMap.get(OpenIdConnectKey.NONCE);</span>
        } else {
<span class="fc" id="L352">            nonce = null;</span>
        }

<span class="pc bpc" id="L355" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.PROMPT)) {</span>
<span class="nc" id="L356">            prompts = Util.splitToSet(Prompt.class, requestMap.get(OpenIdConnectKey.PROMPT));</span>
        } else {
<span class="fc" id="L358">            prompts = Collections.emptySet();</span>
        }

<span class="pc bpc" id="L361" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.REDIRECT_URI)) {</span>
<span class="fc" id="L362">            redirectUri = URI.create(requestMap.get(OpenIdConnectKey.REDIRECT_URI));</span>
        } else {
<span class="nc" id="L364">            redirectUri = null;</span>
        }

<span class="pc bpc" id="L367" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.RESPONSE_TYPE)) {</span>
<span class="fc" id="L368">            responseTypes = Util.splitToSet(ResponseType.class, requestMap.get(OpenIdConnectKey.RESPONSE_TYPE));</span>
        } else {
<span class="nc" id="L370">            responseTypes = Collections.emptySet();</span>
        }
<span class="fc" id="L372">        codeOnlyResponseType = responseTypes.equals(Collections.singleton(ResponseType.code));</span>

<span class="pc bpc" id="L374" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.RESPONSE_MODE)) {</span>
<span class="nc" id="L375">            responseMode = Util.valueOf(ResponseMode.class, requestMap.get(OpenIdConnectKey.RESPONSE_MODE));</span>
        } else {
<span class="fc" id="L377">            responseMode = getDefaultResponseMode();</span>
        }

<span class="pc bpc" id="L380" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.SCOPE)) {</span>
<span class="fc" id="L381">            scopes = Util.splitToSet(Scope.class, requestMap.get(OpenIdConnectKey.SCOPE));</span>
        } else {
<span class="nc" id="L383">            scopes = null;</span>
        }

<span class="pc bpc" id="L386" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.STATE)) {</span>
<span class="nc" id="L387">            state = requestMap.get(OpenIdConnectKey.STATE);</span>
        } else {
<span class="fc" id="L389">            state = null;</span>
        }

<span class="pc bpc" id="L392" title="1 of 2 branches missed.">        if (requestMap.containsKey(OpenIdConnectKey.UI_LOCALES)) {</span>
<span class="nc" id="L393">            uiLocales = Util.splitToLocaleList(requestMap.get(OpenIdConnectKey.UI_LOCALES));</span>
        } else {
<span class="fc" id="L395">            uiLocales = null;</span>
        }

<span class="fc" id="L398">        validate();</span>
<span class="fc" id="L399">    }</span>

    /**
     * Constructs the authentication request using the Request JWT.
     *
     * @param requestJwt
     *            request JWT
     * @param privateJwks
     *            JWKS containing private keys if necessary.
     * @throws GeneralSecurityException
     * @throws IOException
     */
    public AuthenticationRequest(final String requestJwt, final JsonWebKeySet privateJwks) throws IOException, GeneralSecurityException {

<span class="nc" id="L413">        this(buildRequestMap(requestJwt, privateJwks));</span>
<span class="nc" id="L414">    }</span>

    public void addQueryParams(final UriBuilder b) {

<span class="nc bnc" id="L418" title="All 2 branches missed.">        for (final Entry&lt;String, String&gt; entry : requestMap.entrySet()) {</span>
<span class="nc" id="L419">            b.queryParam(entry.getKey(), entry.getValue());</span>
<span class="nc" id="L420">        }</span>
<span class="nc" id="L421">    }</span>

    public boolean containsResponseType(final ResponseType responseType) {

<span class="nc" id="L425">        return responseTypes.contains(responseType);</span>
    }

    public List&lt;String&gt; getAcrValues() {

<span class="nc" id="L430">        return acrValues;</span>
    }

    public JsonObject getClaims() {

<span class="nc" id="L435">        return claims;</span>
    }

    public String getClientId() {

<span class="fc" id="L440">        return clientId;</span>
    }

    /**
     * For purposes of this specification, the default Response Mode for the
     * OAuth 2.0 code Response Type is the query encoding. For purposes of this
     * specification, the default Response Mode for the OAuth 2.0 token Response
     * Type is the fragment encoding.
     *
     * @return default respopnse mode.
     */
    private ResponseMode getDefaultResponseMode() {

<span class="pc bpc" id="L453" title="1 of 2 branches missed.">        if (codeOnlyResponseType) {</span>
<span class="fc" id="L454">            return ResponseMode.query;</span>
        } else {
<span class="nc" id="L456">            return ResponseMode.fragment;</span>
        }

    }

    public Display getDisplay() {

<span class="nc" id="L463">        return display;</span>
    }

    public String getIdTokenHint() {

<span class="nc" id="L468">        return idTokenHint;</span>
    }

    public String getLoginHint() {

<span class="nc" id="L473">        return loginHint;</span>
    }

    public Integer getMaxAge() {

<span class="nc" id="L478">        return maxAge;</span>
    }

    public String getNonce() {

<span class="nc" id="L483">        return nonce;</span>
    }

    public Set&lt;Prompt&gt; getPrompts() {

<span class="nc" id="L488">        return prompts;</span>
    }

    public URI getRedirectUri() {

<span class="nc" id="L493">        return redirectUri;</span>
    }

    public ResponseMode getResponseMode() {

<span class="nc" id="L498">        return responseMode;</span>
    }

    public String getResponseType() {

<span class="nc" id="L503">        final StringBuilder b = new StringBuilder();</span>
<span class="nc" id="L504">        final Iterator&lt;ResponseType&gt; i = responseTypes.iterator();</span>
<span class="nc" id="L505">        b.append(i.next());</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        while (i.hasNext()) {</span>
<span class="nc" id="L507">            b.append(' ');</span>
<span class="nc" id="L508">            b.append(i.next());</span>
        }
<span class="nc" id="L510">        return b.toString();</span>
    }

    public Set&lt;ResponseType&gt; getResponseTypes() {

<span class="nc" id="L515">        return responseTypes;</span>
    }

    /**
     * Gets a string representation of the scope set.
     *
     * @return string representation of the scope set.
     */
    public String getScope() {

<span class="nc" id="L525">        final StringBuilder b = new StringBuilder();</span>
<span class="nc" id="L526">        final Iterator&lt;Scope&gt; i = scopes.iterator();</span>
<span class="nc" id="L527">        b.append(i.next());</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">        while (i.hasNext()) {</span>
<span class="nc" id="L529">            b.append(' ');</span>
<span class="nc" id="L530">            b.append(i.next());</span>
        }
<span class="nc" id="L532">        return b.toString();</span>
    }

    public Set&lt;Scope&gt; getScopes() {

<span class="fc" id="L537">        return scopes;</span>
    }

    public String getState() {

<span class="nc" id="L542">        return state;</span>
    }

    public List&lt;Locale&gt; getUiLocales() {

<span class="nc" id="L547">        return uiLocales;</span>
    }

    /**
     * Checks if the &lt;em&gt;Authorization Code&lt;/em&gt; flow is used. This is
     * &lt;code&gt;true&lt;/code&gt; if the response types contains code and only code.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the response types contains code and only
     *         code
     */
    public boolean isAuthorizationCodeFlow() {

<span class="fc" id="L559">        return codeOnlyResponseType;</span>
    }

    public boolean isDefaultResponseMode() {

<span class="nc bnc" id="L564" title="All 2 branches missed.">        if (codeOnlyResponseType) {</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">            return ResponseMode.query == responseMode;</span>
        } else {
<span class="nc bnc" id="L567" title="All 2 branches missed.">            return ResponseMode.fragment == responseMode;</span>
        }
    }

    /**
     * Checks if we are using the &lt;em&gt;implicit&lt;/em&gt; flow. All but the
     * &lt;code&gt;code&lt;/code&gt; Response Type value, which is defined by OAuth 2.0
     * [RFC6749], are defined in the OAuth 2.0 Multiple Response Type Encoding
     * Practices [OAuth.Responses] specification. NOTE: While OAuth 2.0 also
     * defines the token Response Type value for the Implicit Flow, OpenID
     * Connect does not use this Response Type, since no ID Token would be
     * returned.
     * 
     * @return the response types does not contain &lt;code&gt;code&lt;/code&gt;
     */
    public boolean isImplicitFlow() {

<span class="nc bnc" id="L584" title="All 2 branches missed.">        return !responseTypes.contains(ResponseType.code);</span>
    }

    public JsonObject toJsonObject() {

<span class="nc" id="L589">        final JsonObjectBuilder b = Json.createObjectBuilder();</span>
<span class="nc" id="L590">        b.add(OpenIdConnectKey.CLIENT_ID, clientId);</span>
<span class="nc" id="L591">        b.add(OpenIdConnectKey.REDIRECT_URI, redirectUri.toASCIIString());</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">        if (display != null) {</span>
<span class="nc" id="L593">            b.add(OpenIdConnectKey.DISPLAY, Util.toString(display));</span>
        }
<span class="nc bnc" id="L595" title="All 2 branches missed.">        if (idTokenHint != null) {</span>
<span class="nc" id="L596">            b.add(OpenIdConnectKey.ID_TOKEN_HINT, idTokenHint);</span>
        }
<span class="nc bnc" id="L598" title="All 2 branches missed.">        if (loginHint != null) {</span>
<span class="nc" id="L599">            b.add(OpenIdConnectKey.LOGIN_HINT, loginHint);</span>
        }
<span class="nc bnc" id="L601" title="All 2 branches missed.">        if (maxAge != null) {</span>
<span class="nc" id="L602">            b.add(OpenIdConnectKey.MAX_AGE, maxAge);</span>
        }
<span class="nc bnc" id="L604" title="All 2 branches missed.">        if (claims != null) {</span>
<span class="nc" id="L605">            b.add(OpenIdConnectKey.CLAIMS, claims);</span>
        }
<span class="nc bnc" id="L607" title="All 2 branches missed.">        if (nonce != null) {</span>
<span class="nc" id="L608">            b.add(OpenIdConnectKey.NONCE, nonce);</span>
        }
<span class="nc bnc" id="L610" title="All 2 branches missed.">        if (responseMode != null) {</span>
<span class="nc" id="L611">            b.add(OpenIdConnectKey.RESPONSE_MODE, Util.toString(responseMode));</span>
        }
<span class="nc bnc" id="L613" title="All 2 branches missed.">        if (responseTypes != null) {</span>
<span class="nc" id="L614">            b.add(OpenIdConnectKey.RESPONSE_TYPE, Util.toString(responseTypes));</span>
        }
<span class="nc bnc" id="L616" title="All 2 branches missed.">        if (scopes != null) {</span>
<span class="nc" id="L617">            b.add(OpenIdConnectKey.SCOPE, Util.toString(scopes));</span>
        }
<span class="nc bnc" id="L619" title="All 2 branches missed.">        if (state != null) {</span>
<span class="nc" id="L620">            b.add(OpenIdConnectKey.STATE, state);</span>
        }
<span class="nc bnc" id="L622" title="All 2 branches missed.">        if (acrValues != null) {</span>
<span class="nc" id="L623">            b.add(OpenIdConnectKey.ACR_VALUES, Util.join(acrValues));</span>
        }
<span class="nc bnc" id="L625" title="All 2 branches missed.">        if (uiLocales != null) {</span>
<span class="nc" id="L626">            b.add(OpenIdConnectKey.UI_LOCALES, Util.toLocaleString(uiLocales));</span>
        }
<span class="nc" id="L628">        return b.build();</span>
    }

    /**
     * Performs the validation on the Authentication token.
     */
    private void validate() {

<span class="pc bpc" id="L636" title="1 of 2 branches missed.">        if (responseTypes.isEmpty()) {</span>
<span class="nc" id="L637">            throw new RedirectedOpenIdProviderException(this, new ErrorResponse(invalid_request, &quot;the request must contain the 'response_types'&quot;), false);</span>
        }
<span class="pc bpc" id="L639" title="1 of 2 branches missed.">        if (redirectUri == null) {</span>
<span class="nc" id="L640">            throw new BadRequestException(&quot;the request must contain the 'redirect_uri'&quot;);</span>
        }

<span class="pc bpc" id="L643" title="1 of 2 branches missed.">        if (clientId == null) {</span>
<span class="nc" id="L644">            throw new RedirectedOpenIdProviderException(this, new ErrorResponse(invalid_request, &quot;the request must contain the 'client_id'&quot;));</span>
        }

<span class="pc bpc" id="L647" title="1 of 2 branches missed.">        if (!scopes.contains(Scope.openid)) {</span>
<span class="nc" id="L648">            throw new RedirectedOpenIdProviderException(this, new ErrorResponse(invalid_request, &quot;the request must contain the 'openid' scope value&quot;));</span>
        }

<span class="pc bpc" id="L651" title="3 of 4 branches missed.">        if (prompts.contains(Prompt.none) &amp;&amp; prompts.size() != 1) {</span>

<span class="nc" id="L653">            throw new RedirectedOpenIdProviderException(this, new ErrorResponse(invalid_request, &quot;Cannot have 'none' with any other value for 'prompt'&quot;));</span>

        }

<span class="pc bpc" id="L657" title="3 of 4 branches missed.">        if (!isAuthorizationCodeFlow() &amp;&amp; !Util.isNotNullOrEmpty(nonce)) {</span>
<span class="nc" id="L658">            throw new RedirectedOpenIdProviderException(this, new ErrorResponse(invalid_request, &quot;'nonce' required for 'code' flow&quot;));</span>
        }

<span class="pc bpc" id="L661" title="1 of 2 branches missed.">        if (responseTypes.isEmpty()) {</span>

<span class="nc" id="L663">            throw new RedirectedOpenIdProviderException(this, new ErrorResponse(invalid_request, &quot;the request must contain the 'response_type'&quot;));</span>

        }

<span class="pc bpc" id="L667" title="3 of 4 branches missed.">        if (responseTypes.contains(ResponseType.none) &amp;&amp; responseTypes.size() != 1) {</span>

<span class="nc" id="L669">            throw new RedirectedOpenIdProviderException(this, new ErrorResponse(invalid_request, &quot;Cannot have 'none' with any other value for 'response_type'&quot;));</span>

        }

<span class="pc bpc" id="L673" title="2 of 4 branches missed.">        if (responseMode == ResponseMode.query &amp;&amp; !codeOnlyResponseType) {</span>

<span class="nc" id="L675">            throw new RedirectedOpenIdProviderException(this, new ErrorResponse(invalid_request, &quot;Invalid response mode for the response type requested.&quot;));</span>

        }
<span class="fc" id="L678">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>