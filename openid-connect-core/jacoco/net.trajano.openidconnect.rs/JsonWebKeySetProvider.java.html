<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>JsonWebKeySetProvider.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">openid-connect-core</a> &gt; <a href="index.source.html" class="el_package">net.trajano.openidconnect.rs</a> &gt; <span class="el_source">JsonWebKeySetProvider.java</span></div><h1>JsonWebKeySetProvider.java</h1><pre class="source lang-java linenums">package net.trajano.openidconnect.rs;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.lang.annotation.Annotation;
import java.lang.reflect.Type;

import javax.json.Json;
import javax.json.JsonArray;
import javax.json.JsonArrayBuilder;
import javax.json.JsonObject;
import javax.json.JsonValue;
import javax.json.JsonWriter;
import javax.ws.rs.Consumes;
import javax.ws.rs.Produces;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.MultivaluedMap;
import javax.ws.rs.ext.MessageBodyReader;
import javax.ws.rs.ext.MessageBodyWriter;
import javax.ws.rs.ext.Provider;
import javax.ws.rs.ext.Providers;

import net.trajano.openidconnect.crypto.JsonWebKey;
import net.trajano.openidconnect.crypto.JsonWebKeySet;
import net.trajano.openidconnect.internal.CharSets;

// TODO should we have the reader in jaspic and the writer in the rest api?
@Provider
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
<span class="fc" id="L36">public class JsonWebKeySetProvider implements MessageBodyReader&lt;JsonWebKeySet&gt;, MessageBodyWriter&lt;JsonWebKeySet&gt; {</span>

    private Providers providers;

    @Override
    public long getSize(final JsonWebKeySet jwks,
            final Class&lt;?&gt; type,
            final Type genericType,
            final Annotation[] annotations,
            final MediaType mediaType) {

<span class="nc" id="L47">        return -1;</span>
    }

    @Override
    public boolean isReadable(final Class&lt;?&gt; type,
            final Type genericType,
            final Annotation[] annotations,
            final MediaType mediaType) {

<span class="pc bpc" id="L56" title="2 of 4 branches missed.">        return JsonWebKeySet.class.isAssignableFrom(type) &amp;&amp; MediaType.APPLICATION_JSON_TYPE.isCompatible(mediaType);</span>
    }

    @Override
    public boolean isWriteable(final Class&lt;?&gt; type,
            final Type genericType,
            final Annotation[] annotations,
            final MediaType mediaType) {

<span class="fc" id="L65">        return isReadable(type, genericType, annotations, mediaType);</span>
    }

    @Override
    public JsonWebKeySet readFrom(final Class&lt;JsonWebKeySet&gt; type,
            final Type genericType,
            final Annotation[] annotations,
            final MediaType mediaType,
            final MultivaluedMap&lt;String, String&gt; httpHeaders,
            final InputStream inputStream) throws IOException,
            WebApplicationException {

<span class="fc" id="L77">        final JsonArray keysArray = Json.createReader(inputStream)</span>
                .readObject()
                .getJsonArray(&quot;keys&quot;);

<span class="fc" id="L81">        final JsonWebKeySet keySet = new JsonWebKeySet();</span>
<span class="fc" id="L82">        final MessageBodyReader&lt;JsonWebKey&gt; reader = providers.getMessageBodyReader(JsonWebKey.class, JsonWebKey.class, annotations, mediaType);</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">        for (final JsonValue key : keysArray) {</span>
<span class="fc" id="L84">            final InputStream keyStream = new ByteArrayInputStream(key.toString()</span>
                    .getBytes(CharSets.UTF8));
<span class="fc" id="L86">            final JsonWebKey jsonWebKey = reader.readFrom(JsonWebKey.class, null, annotations, mediaType, null, keyStream);</span>
<span class="fc" id="L87">            keySet.add(jsonWebKey);</span>
<span class="fc" id="L88">        }</span>

<span class="fc" id="L90">        return keySet;</span>
    }

    @Context
    public void setProviders(final Providers providers) {

<span class="fc" id="L96">        this.providers = providers;</span>
<span class="fc" id="L97">    }</span>

    @Override
    public void writeTo(final JsonWebKeySet jwks,
            final Class&lt;?&gt; type,
            final Type genericType,
            final Annotation[] annotations,
            final MediaType mediaType,
            final MultivaluedMap&lt;String, Object&gt; httpHeaders,
            final OutputStream os) throws IOException,
            WebApplicationException {

<span class="fc" id="L109">        final MessageBodyWriter&lt;JsonWebKey&gt; writer = providers.getMessageBodyWriter(JsonWebKey.class, JsonWebKey.class, annotations, mediaType);</span>
<span class="fc" id="L110">        final JsonArrayBuilder keysArray = Json.createArrayBuilder();</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">        for (final JsonWebKey key : jwks.getKeys()) {</span>
<span class="fc" id="L112">            final ByteArrayOutputStream keyStream = new ByteArrayOutputStream();</span>
<span class="fc" id="L113">            writer.writeTo(key, JsonWebKey.class, null, annotations, mediaType, null, keyStream);</span>
<span class="fc" id="L114">            keyStream.close();</span>
<span class="fc" id="L115">            keysArray.add(Json.createReader(new ByteArrayInputStream(keyStream.toByteArray()))</span>
                    .readObject());
        }
<span class="fc" id="L118">        final JsonObject jwksObject = Json.createObjectBuilder()</span>
                .add(&quot;keys&quot;, keysArray)
                .build();
<span class="fc" id="L121">        final JsonWriter w = Json.createWriter(os);</span>
<span class="fc" id="L122">        w.write(jwksObject);</span>
<span class="fc" id="L123">        w.close();</span>
<span class="fc" id="L124">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>