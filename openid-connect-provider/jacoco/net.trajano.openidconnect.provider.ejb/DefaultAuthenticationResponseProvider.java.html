<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DefaultAuthenticationResponseProvider.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">openid-connect-provider</a> &gt; <a href="index.source.html" class="el_package">net.trajano.openidconnect.provider.ejb</a> &gt; <span class="el_source">DefaultAuthenticationResponseProvider.java</span></div><h1>DefaultAuthenticationResponseProvider.java</h1><pre class="source lang-java linenums">package net.trajano.openidconnect.provider.ejb;

import static java.net.URI.create;

import java.io.IOException;
import java.net.URI;
import java.security.GeneralSecurityException;

import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.UriBuilder;

import net.trajano.openidconnect.auth.AuthenticationRequest;
import net.trajano.openidconnect.auth.AuthenticationResponse;
import net.trajano.openidconnect.auth.ResponseMode;
import net.trajano.openidconnect.auth.ResponseType;
import net.trajano.openidconnect.core.OpenIdConnectKey;
import net.trajano.openidconnect.provider.internal.AuthenticationResponseConverter;
import net.trajano.openidconnect.provider.internal.CacheConstants;
import net.trajano.openidconnect.provider.spi.AuthenticationResponseProvider;
import net.trajano.openidconnect.provider.spi.Authenticator;
import net.trajano.openidconnect.provider.spi.ClientManager;
import net.trajano.openidconnect.provider.spi.Consent;
import net.trajano.openidconnect.provider.spi.KeyProvider;
import net.trajano.openidconnect.provider.spi.TokenProvider;
import net.trajano.openidconnect.token.IdTokenResponse;
import net.trajano.openidconnect.token.TokenResponse;

/**
 * Upon successful authentication, implementers are expected to invoke any of
 * the methods below. This class is meant to be injected into a servlet or REST
 * service.
 *
 * @author Archimedes Trajano
 */
@Stateless
<span class="nc" id="L44">public class DefaultAuthenticationResponseProvider implements</span>
    AuthenticationResponseProvider {

    @EJB
    private Authenticator authenticator;

    @EJB
    private ClientManager clientManager;

    private KeyProvider keyProvider;

    @Context
    javax.ws.rs.ext.Providers providers;

    private TokenProvider tokenProvider;

    /**
     * @param responseType
     *            response_type value
     * @param subject
     *            subject
     * @param state
     *            state
     * @param redirectUri
     *            redirect URI.
     * @param extraOptions
     *            extra options for building the idtoken
     * @throws GeneralSecurityException
     * @throws IOException
     */
    @Override
    public AuthenticationResponse buildAuthenticationResponse(final AuthenticationRequest request,
        final HttpServletRequest req,
        final String subject) throws IOException,
            GeneralSecurityException {

<span class="nc" id="L80">        final AuthenticationResponse response = new AuthenticationResponse();</span>

<span class="nc" id="L82">        final UriBuilder issuerUri = UriBuilder.fromUri(create(req.getRequestURL()</span>
<span class="nc" id="L83">            .toString()))</span>
<span class="nc" id="L84">            .scheme(&quot;https&quot;)</span>
<span class="nc" id="L85">            .replacePath(req.getContextPath())</span>
<span class="nc" id="L86">            .replaceQuery(null)</span>
<span class="nc" id="L87">            .fragment(null);</span>

<span class="nc" id="L89">        final String code = tokenProvider.createNewToken(subject, issuerUri.build(), request);</span>

<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (request.getState() != null) {</span>
<span class="nc" id="L92">            response.setState(request.getState());</span>
        }

<span class="nc" id="L95">        final boolean implicitFlow = request.isImplicitFlow();</span>
<span class="nc" id="L96">        final IdTokenResponse tokenResponse = tokenProvider.getByCode(code, implicitFlow);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">        if (request.containsResponseType(ResponseType.id_token)) {</span>
<span class="nc" id="L98">            response.setEncodedIdToken(tokenResponse.getEncodedIdToken());</span>
        }
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (request.containsResponseType(ResponseType.token)) {</span>
<span class="nc" id="L101">            response.setAccessToken(TokenResponse.BEARER, tokenResponse.getAccessToken());</span>
        }
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if (request.containsResponseType(ResponseType.code)) {</span>
<span class="nc" id="L104">            response.setCode(code);</span>
        }
<span class="nc" id="L106">        response.setRedirectUri(request.getRedirectUri());</span>
<span class="nc" id="L107">        response.setResponseMode(request.getResponseMode());</span>
<span class="nc" id="L108">        return response;</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Response buildResponse(final AuthenticationRequest req,
        final HttpServletRequest request,
        final String subject) {

<span class="nc" id="L119">        return buildResponse(req, request, subject, false);</span>
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Response buildResponse(final AuthenticationRequest req,
        final HttpServletRequest request,
        final String subject,
        final boolean consent) {

        final AuthenticationResponse response;
        try {
<span class="nc" id="L133">            response = buildAuthenticationResponse(req, request, subject);</span>
<span class="nc" id="L134">        } catch (IOException</span>
<span class="nc" id="L135">            | GeneralSecurityException e) {</span>
<span class="nc" id="L136">            throw new WebApplicationException(e);</span>
        }
<span class="nc" id="L138">        final AuthenticationResponseConverter converter = new AuthenticationResponseConverter(response.getRedirectUri(), response);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (response.getResponseMode() == ResponseMode.query) {</span>
<span class="nc" id="L140">            return Response.temporaryRedirect(converter.toQueryUri())</span>
<span class="nc" id="L141">                .build();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">        } else if (response.getResponseMode() == ResponseMode.form_post) {</span>

<span class="nc" id="L144">            return Response.ok(converter.toFormPost())</span>
<span class="nc" id="L145">                .type(MediaType.TEXT_HTML_TYPE)</span>
<span class="nc" id="L146">                .cacheControl(CacheConstants.NO_CACHE)</span>
<span class="nc" id="L147">                .build();</span>
        } else {
<span class="nc" id="L149">            return Response.temporaryRedirect(converter.toFragmentUri())</span>
<span class="nc" id="L150">                .build();</span>
        }
    }

    /**
     * {@inheritDoc}
     */
    @Override
    public Response buildResponse(final String requestJwt,
        final HttpServletRequest request,
        final String subject) {

        try {
<span class="nc" id="L163">            final AuthenticationRequest req = new AuthenticationRequest(requestJwt, keyProvider.getPrivateJwks());</span>
<span class="nc" id="L164">            return buildResponse(req, request, subject);</span>
        } catch (IOException
<span class="nc" id="L166">            | GeneralSecurityException e) {</span>
<span class="nc" id="L167">            throw new WebApplicationException(e);</span>
        }

    }

    @Override
    public Response buildResponse(final String requestJwt,
        final HttpServletRequest request,
        final String subject,
        final boolean consent) {

        // TODO Auto-generated method stub
<span class="nc" id="L179">        return null;</span>
    }

    /**
     * Calls for the authentication callback. Perform a redirect with the
     * authorization response data.
     *
     * @param response
     * @param responseType
     * @param subject
     * @param state
     * @param redirectUri
     * @param extraStorageOptions
     * @throws IOException
     */
    @Override
    public void doCallback(final HttpServletRequest req,
        final HttpServletResponse response,
        final String subject) throws IOException,
            ServletException {

<span class="nc" id="L200">        doConsentCallback(req, response, subject, false);</span>

<span class="nc" id="L202">    }</span>

    @Override
    public void doConsentCallback(final HttpServletRequest req,
        final HttpServletResponse response,
        final String subject,
        final boolean consent) throws IOException,
            ServletException {

<span class="nc" id="L211">        final String requestJwt = req.getParameter(OpenIdConnectKey.REQUEST);</span>
        try {
<span class="nc" id="L213">            final AuthenticationRequest authReq = new AuthenticationRequest(requestJwt, keyProvider.getPrivateJwks());</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">            if (!consent) {</span>
<span class="nc" id="L216">                final URI consentRequestURI = getConsentRequestUri(requestJwt, authReq, req, subject);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                if (consentRequestURI != null) {</span>
<span class="nc" id="L218">                    response.sendRedirect(consentRequestURI.toASCIIString());</span>
<span class="nc" id="L219">                    return;</span>
                }
            }
<span class="nc" id="L222">            final AuthenticationResponse authResponse = buildAuthenticationResponse(authReq, req, subject);</span>
<span class="nc" id="L223">            final AuthenticationResponseConverter authenticationResponse = new AuthenticationResponseConverter(authResponse.getRedirectUri(), authResponse);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (authResponse.getResponseMode() == ResponseMode.query) {</span>
<span class="nc" id="L225">                response.sendRedirect(authenticationResponse.toQueryUri()</span>
<span class="nc" id="L226">                    .toASCIIString());</span>

<span class="nc bnc" id="L228" title="All 2 branches missed.">            } else if (authResponse.getResponseMode() == ResponseMode.form_post) {</span>
<span class="nc" id="L229">                final String formPost = authenticationResponse.toFormPost();</span>
<span class="nc" id="L230">                response.setContentLength(formPost.length());</span>
<span class="nc" id="L231">                response.getWriter()</span>
<span class="nc" id="L232">                    .print(formPost);</span>
<span class="nc" id="L233">            } else {</span>
<span class="nc" id="L234">                response.sendRedirect(authenticationResponse.toFragmentUri()</span>
<span class="nc" id="L235">                    .toASCIIString());</span>
            }
<span class="nc" id="L237">        } catch (final GeneralSecurityException e) {</span>
<span class="nc" id="L238">            throw new ServletException(e);</span>
        }

<span class="nc" id="L241">    }</span>

    /**
     * Gets the consent URI assuming the user has not consented yet.
     *
     * @param requestJwt
     * @param authReq
     * @param req
     * @param subject
     * @return
     * @throws IOException
     * @throws GeneralSecurityException
     */
    private URI getConsentRequestUri(final String requestJwt,
        final AuthenticationRequest authReq,
        final HttpServletRequest req,
        final String subject) throws IOException,
            GeneralSecurityException {

<span class="nc" id="L260">        final Consent consentRequested = new Consent(authenticator.getSubject(req), authReq.getClientId(), authReq.getScopes());</span>

<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (tokenProvider.getByConsent(consentRequested) == null) {</span>
<span class="nc" id="L263">            final UriBuilder contextUriBuilder = UriBuilder.fromUri(req.getRequestURL()</span>
<span class="nc" id="L264">                .toString())</span>
<span class="nc" id="L265">                .replacePath(req.getContextPath());</span>

<span class="nc" id="L267">            return authenticator.consent(authReq, requestJwt, req, contextUriBuilder);</span>
        }
<span class="nc" id="L269">        return null;</span>
    }

    @EJB
    public void setKeyProvider(final KeyProvider keyProvider) {

<span class="nc" id="L275">        this.keyProvider = keyProvider;</span>
<span class="nc" id="L276">    }</span>

    @EJB
    public void setTokenProvider(final TokenProvider tokenProvider) {

<span class="nc" id="L281">        this.tokenProvider = tokenProvider;</span>
<span class="nc" id="L282">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>