<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>EndSessionEndpoint.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">openid-connect-provider</a> &gt; <a href="index.source.html" class="el_package">net.trajano.openidconnect.provider.endpoints</a> &gt; <span class="el_source">EndSessionEndpoint.java</span></div><h1>EndSessionEndpoint.java</h1><pre class="source lang-java linenums">package net.trajano.openidconnect.provider.endpoints;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.lang.annotation.Annotation;
import java.net.URI;
import java.security.GeneralSecurityException;

import javax.ejb.EJB;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import javax.validation.constraints.NotNull;
import javax.ws.rs.FormParam;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.Context;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.ws.rs.core.UriBuilder;
import javax.ws.rs.ext.MessageBodyReader;
import javax.ws.rs.ext.Providers;

import net.trajano.openidconnect.core.ErrorCode;
import net.trajano.openidconnect.core.OpenIdConnectException;
import net.trajano.openidconnect.core.OpenIdConnectKey;
import net.trajano.openidconnect.crypto.JsonWebTokenProcessor;
import net.trajano.openidconnect.provider.spi.Authenticator;
import net.trajano.openidconnect.provider.spi.ClientManager;
import net.trajano.openidconnect.provider.spi.KeyProvider;
import net.trajano.openidconnect.provider.spi.TokenProvider;
import net.trajano.openidconnect.token.IdToken;

/**
 * An RP can notify the OP that the End-User has logged out of the site, and
 * might want to log out of the OP as well. In this case, the RP, after having
 * logged the End-User out of the RP, redirects the End-User's User Agent to the
 * OP's logout endpoint URL. This URL is normally obtained via the
 * end_session_endpoint element of the OP's Discovery response, or may be
 * learned via other mechanisms.
 *
 * @author Archimedes
 */
@Path(&quot;end&quot;)
@Produces(MediaType.APPLICATION_JSON)
<span class="nc" id="L48">public class EndSessionEndpoint {</span>

    @EJB
    private Authenticator authenticator;

    @EJB
    private ClientManager clientManager;

    @EJB
    private KeyProvider keyProvider;

    @Context
    private Providers providers;

    @EJB
    private TokenProvider tokenProvider;

    /**
     * @param nonce
     *            nonce
     * @param logout
     *            if true then the session is terminated before the redirect
     * @param req
     * @return
     * @throws IOException
     * @throws GeneralSecurityException
     */
    @POST
    @Path(&quot;confirm&quot;)
    public Response confirm(@NotNull @FormParam(&quot;nonce&quot;) final String nonce,
            @NotNull @FormParam(&quot;logout&quot;) final boolean logout,
            @Context final HttpServletRequest req) throws IOException,
                    GeneralSecurityException {

<span class="nc" id="L82">        final HttpSession session = req.getSession(false);</span>
<span class="nc bnc" id="L83" title="All 4 branches missed.">        if (session == null || !session.getAttribute(&quot;nonce&quot;)</span>
                .equals(nonce)) {
<span class="nc" id="L85">            throw new OpenIdConnectException(ErrorCode.access_denied);</span>
        }

<span class="nc" id="L88">        final URI postLogoutRedirectUri = (URI) session.getAttribute(&quot;post_logout_redirect_uri&quot;);</span>
<span class="nc" id="L89">        final String state = (String) session.getAttribute(&quot;state&quot;);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        if (logout) {</span>
<span class="nc" id="L91">            authenticator.endSession(req);</span>
<span class="nc" id="L92">            session.invalidate();</span>
        }
<span class="nc" id="L94">        return Response.temporaryRedirect(UriBuilder.fromUri(postLogoutRedirectUri)</span>
                .queryParam(OpenIdConnectKey.STATE, state)
                .build())
                .build();

    }

    /**
     * &lt;p&gt;
     * The Client sends the UserInfo Request using either HTTP GET or HTTP POST.
     * The Access Token obtained from an OpenID Connect Authentication Request
     * MUST be sent as a Bearer Token, per Section 2 of OAuth 2.0 Bearer Token
     * Usage [RFC6750].
     * &lt;/p&gt;
     * &lt;p&gt;
     * It is RECOMMENDED that the request use the HTTP GET method and the Access
     * Token be sent using the Authorization header field.
     * &lt;/p&gt;
     *
     * @param req
     * @return
     * @throws GeneralSecurityException
     * @throws IOException
     */
    @GET
    public Response getOp(@QueryParam(&quot;post_logout_redirect_uri&quot;) final URI postLogoutRedirectUri,
            @QueryParam(OpenIdConnectKey.ID_TOKEN_HINT) final String idTokenHint,
            @QueryParam(OpenIdConnectKey.STATE) final String state,
            @Context final HttpServletRequest req) throws IOException,
                    GeneralSecurityException {

<span class="nc" id="L125">        return op(postLogoutRedirectUri, idTokenHint, state, req);</span>
    }

    /**
     * &lt;p&gt;
     * This endpoint will store the needed logout information in the HTTP
     * session when available.
     * &lt;/p&gt;
     * &lt;p&gt;
     * The &lt;code&gt;id_token_hint&lt;/code&gt; is required by this implementation.
     * &lt;/p&gt;
     *
     * @param postLogoutRedirectUri
     *            OPTIONAL. URL to which the RP is requesting that the
     *            End-User's User Agent be redirected after a logout has been
     *            performed. The value MUST have been previously registered with
     *            the OP, either using the post_logout_redirect_uris
     *            Registration parameter or via another mechanism. If supplied,
     *            the OP SHOULD honor this request following the logout.
     * @param idTokenHint
     *            RECOMMENDED. Previously issued ID Token passed to the logout
     *            endpoint as a hint about the End-User's current authenticated
     *            session with the Client. This is used as an indication of the
     *            identity of the End-User that the RP is requesting be logged
     *            out by the OP. The OP need not be listed as an audience of the
     *            ID Token when it is used as an id_token_hint value.
     * @param state
     *            OPTIONAL. Opaque value used by the RP to maintain state
     *            between the logout request and the callback to the endpoint
     *            specified by the post_logout_redirect_uri parameter. If
     *            included in the logout request, the OP passes this value back
     *            to the RP using the state query parameter when redirecting the
     *            User Agent back to the RP.
     * @param req
     * @return
     * @throws GeneralSecurityException
     * @throws IOException
     */
    @POST
    public Response op(@FormParam(&quot;post_logout_redirect_uri&quot;) final URI postLogoutRedirectUri,
            @FormParam(OpenIdConnectKey.ID_TOKEN_HINT) final String idTokenHint,
            @FormParam(OpenIdConnectKey.STATE) final String state,
            @Context final HttpServletRequest req) throws IOException,
                    GeneralSecurityException {

<span class="nc" id="L170">        IdToken idToken = null;</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (idTokenHint != null) {</span>
<span class="nc" id="L172">            final JsonWebTokenProcessor idTokenProcessor = new JsonWebTokenProcessor(idTokenHint).jwks(keyProvider.getPrivateJwks());</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            if (!idTokenProcessor.isJwkAvailable()) {</span>
<span class="nc" id="L174">                throw new OpenIdConnectException(ErrorCode.invalid_request, &quot;no jwk available for kid&quot;);</span>
            }
<span class="nc" id="L176">            final byte[] idTokenBytes = idTokenProcessor.getPayload();</span>
<span class="nc" id="L177">            final MessageBodyReader&lt;IdToken&gt; idTokenReader = providers.getMessageBodyReader(IdToken.class, IdToken.class, new Annotation[0], MediaType.APPLICATION_JSON_TYPE);</span>
<span class="nc" id="L178">            idToken = idTokenReader.readFrom(IdToken.class, IdToken.class, new Annotation[0], MediaType.APPLICATION_JSON_TYPE, null, new ByteArrayInputStream(idTokenBytes));</span>
        }
<span class="nc bnc" id="L180" title="All 6 branches missed.">        if (postLogoutRedirectUri != null &amp;&amp; idToken != null &amp;&amp; !clientManager.isPostLogoutRedirectUriValidForClient(idToken.getAzp(), postLogoutRedirectUri)) {</span>
<span class="nc" id="L181">            throw new OpenIdConnectException(ErrorCode.invalid_request);</span>
        }

<span class="nc" id="L184">        final HttpSession session = req.getSession(false);</span>
<span class="nc bnc" id="L185" title="All 4 branches missed.">        if (session != null &amp;&amp; authenticator.isAuthenticated(req)) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (!authenticator.getSubject(req)</span>
                    .equals(idToken.getSub())) {
<span class="nc" id="L188">                throw new OpenIdConnectException(ErrorCode.access_denied);</span>
            }
<span class="nc" id="L190">            final UriBuilder uriBuilder = UriBuilder.fromUri(req.getRequestURL()</span>
                    .toString())
                    .replacePath(req.getContextPath());

<span class="nc" id="L194">            session.setAttribute(&quot;post_logout_redirect_uri&quot;, postLogoutRedirectUri);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">            if (idToken != null) {</span>
<span class="nc" id="L196">                session.setAttribute(&quot;id_token&quot;, idToken);</span>
            }
<span class="nc" id="L198">            session.setAttribute(&quot;state&quot;, state);</span>
<span class="nc" id="L199">            final String nonce = keyProvider.nextEncodedToken();</span>
<span class="nc" id="L200">            session.setAttribute(&quot;nonce&quot;, nonce);</span>

<span class="nc" id="L202">            return Response.temporaryRedirect(authenticator.logout(nonce, idToken, state, postLogoutRedirectUri, req, uriBuilder))</span>
                    .build();
        }
        // If the user is not authenticated, it just goes back to the post
        // redirect URI.
<span class="nc" id="L207">        return Response.temporaryRedirect(UriBuilder.fromUri(postLogoutRedirectUri)</span>
                .queryParam(OpenIdConnectKey.STATE, state)
                .build())
                .build();

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>